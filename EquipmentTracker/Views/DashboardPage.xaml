<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:EquipmentTracker.ViewModels"
             xmlns:models="clr-namespace:EquipmentTracker.Models"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="EquipmentTracker.Views.DashboardPage"
             x:DataType="vm:DashboardViewModel"
             Title="{Binding Title}"
             BackgroundColor="{StaticResource Gray100}">

    <ContentPage.Behaviors>
        <toolkit:EventToCommandBehavior
            EventName="Appearing"
            Command="{Binding LoadStatisticsCommand}" />
    </ContentPage.Behaviors>

    <ContentPage.Resources>
        <Style TargetType="Frame" x:Key="StatCard">
            <Setter Property="Padding" Value="15"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="BackgroundColor" Value="White"/>
            <Setter Property="BorderColor" Value="{StaticResource Gray300}"/>
            <Setter Property="Margin" Value="5"/>
        </Style>
        <Style TargetType="Label" x:Key="StatValue">
            <Setter Property="FontSize" Value="32"/>
            <Setter Property="FontAttributes" Value="Bold"/>
            <Setter Property="TextColor" Value="{StaticResource Primary}"/>
            <Setter Property="HorizontalOptions" Value="Center"/>
        </Style>
        <Style TargetType="Label" x:Key="StatTitle">
            <Setter Property="FontSize" Value="Small"/>
            <Setter Property="TextColor" Value="{StaticResource Gray600}"/>
            <Setter Property="HorizontalOptions" Value="Center"/>
        </Style>
    </ContentPage.Resources>

    <Grid>
        <ScrollView>
            <VerticalStackLayout Padding="10" Spacing="10">

                <Frame BackgroundColor="#FFEBEE" 
                       BorderColor="#FFCDD2" 
                       CornerRadius="10" 
                       Padding="15" 
                       IsVisible="{Binding IsConnectionError}">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="⚠️ Bağlantı Hatası" 
                               TextColor="#D32F2F" 
                               FontAttributes="Bold" 
                               FontSize="Medium"/>
                        <Label Text="{Binding ConnectionErrorMessage}" 
                               TextColor="#C62828" 
                               FontSize="Small"/>
                        <Button Text="Ayarları Yapılandır" 
                                Command="{Binding GoToSettingsCommand}" 
                                BackgroundColor="#D32F2F" 
                                TextColor="White" 
                                HorizontalOptions="End"
                                HeightRequest="40"/>
                    </VerticalStackLayout>
                </Frame>

                <Label Text="Genel Bakış" FontSize="Large" FontAttributes="Bold" Margin="5,0,0,10" TextColor="Black"/>

                <Grid ColumnDefinitions="*,*,*" RowDefinitions="Auto,Auto">
                    <Frame Grid.Column="0" Grid.Row="0" Style="{StaticResource StatCard}">
                        <VerticalStackLayout>
                            <Label Text="{Binding Stats.TotalJobs}" Style="{StaticResource StatValue}"/>
                            <Label Text="Toplam İş" Style="{StaticResource StatTitle}"/>
                        </VerticalStackLayout>
                    </Frame>
                    <Frame Grid.Column="1" Grid.Row="0" Style="{StaticResource StatCard}">
                        <VerticalStackLayout>
                            <Label Text="{Binding Stats.TotalEquipments}" Style="{StaticResource StatValue}"/>
                            <Label Text="Toplam Ekipman" Style="{StaticResource StatTitle}"/>
                        </VerticalStackLayout>
                    </Frame>
                    <Frame Grid.Column="2" Grid.Row="0" Style="{StaticResource StatCard}">
                        <VerticalStackLayout>
                            <Label Text="{Binding Stats.TotalParts}" Style="{StaticResource StatValue}"/>
                            <Label Text="Toplam Parça" Style="{StaticResource StatTitle}"/>
                        </VerticalStackLayout>
                    </Frame>
                    <Frame Grid.Column="0" Grid.Row="1" Style="{StaticResource StatCard}">
                        <VerticalStackLayout>
                            <Label Text="{Binding Stats.TotalAttachments}" Style="{StaticResource StatValue}"/>
                            <Label Text="Toplam Dosya" Style="{StaticResource StatTitle}"/>
                        </VerticalStackLayout>
                    </Frame>
                </Grid>

                <Label Text="Analiz" FontSize="Large" FontAttributes="Bold" Margin="5,20,0,10" TextColor="Black"/>

                <VerticalStackLayout>
                    <Frame Style="{StaticResource StatCard}">
                        <VerticalStackLayout Spacing="5">
                            <Label Text="En Fazla Ekipmana Sahip İş" Style="{StaticResource StatTitle}" HorizontalOptions="Start"/>
                            <Label Text="{Binding Stats.JobWithMostEquipment}" Style="{StaticResource StatValue}" FontSize="Large" HorizontalOptions="Start" TextColor="{StaticResource Black}"/>
                        </VerticalStackLayout>
                    </Frame>
                    <Frame Style="{StaticResource StatCard}">
                        <VerticalStackLayout Spacing="5">
                            <Label Text="En Fazla Parçaya Sahip İş" Style="{StaticResource StatTitle}" HorizontalOptions="Start"/>
                            <Label Text="{Binding Stats.JobWithMostParts}" Style="{StaticResource StatValue}" FontSize="Large" HorizontalOptions="Start" TextColor="{StaticResource Black}"/>
                        </VerticalStackLayout>
                    </Frame>
                </VerticalStackLayout>

                <Frame IsVisible="{Binding IsAdminUser}"
                       BorderColor="{StaticResource Primary}"
                       BackgroundColor="#F0F8FF"
                       Padding="15"
                       Margin="0,20,0,0"
                       CornerRadius="10">

                    <VerticalStackLayout Spacing="10">
                        <Label Text="Aktif Kullanıcılar (Yönetici Paneli)" 
                               FontAttributes="Bold" 
                               FontSize="Medium" 
                               TextColor="{StaticResource Primary}"/>

                        <BoxView HeightRequest="1" Color="LightGray"/>

                        <CollectionView ItemsSource="{Binding ActiveUsers}" HeightRequest="200">
                            <CollectionView.EmptyView>
                                <Label Text="Şu an başka aktif kullanıcı yok." TextColor="Gray" HorizontalOptions="Center"/>
                            </CollectionView.EmptyView>

                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:User">
                                    <Grid ColumnDefinitions="*, Auto" Padding="5">

                                        <VerticalStackLayout Grid.Column="0" VerticalOptions="Center">
                                            <Label Text="{Binding FullName}" FontAttributes="Bold" TextColor="Black"/>
                                            <Label Text="{Binding Username}" FontSize="Small" TextColor="Gray"/>
                                        </VerticalStackLayout>

                                        <HorizontalStackLayout Grid.Column="1" Spacing="10" VerticalOptions="Center">
                                            <Label Text="● Çevrimiçi" TextColor="Green" FontSize="Small" VerticalOptions="Center"/>

                                            <Button Text="KES" 
                                                    FontSize="10"
                                                    HeightRequest="30"
                                                    BackgroundColor="Red"
                                                    TextColor="White"
                                                    Padding="5,0"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DashboardViewModel}}, Path=DisconnectUserCommand}"
                                                    CommandParameter="{Binding .}"/>
                                        </HorizontalStackLayout>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Frame>
            </VerticalStackLayout>
        </ScrollView>

        <Grid IsVisible="{Binding IsBusy}" BackgroundColor="#80000000">
            <ActivityIndicator IsRunning="{Binding IsBusy}" Color="White" Scale="2" HorizontalOptions="Center" VerticalOptions="Center"/>
        </Grid>
    </Grid>
</ContentPage>